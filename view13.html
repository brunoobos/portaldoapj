<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escala 24x7 - Visualização</title>

<style>
  body {
    font-family: Arial, sans-serif;
  }
  label, select, button {
    margin: 0 8px 12px 0;
  }
  #relatorio {
    margin-top: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #666;
    padding: 6px;
    text-align: center;
  }
  th {
    background-color: #eee;
  }
  
  /* Estilo para impressão */
  @media print {
    body * {
      visibility: hidden;
    }
    #relatorio, #relatorio * {
      visibility: visible;
    }
    #relatorio {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
  }
</style>

<!-- Firebase SDK Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>Visualização da Escala</h2>

<label for="selectMes">Mês:</label>
<select id="selectMes"></select>

<label for="selectAno">Ano:</label>
<select id="selectAno"></select>

<label for="selectEquipe">Equipe:</label>
<select id="selectEquipe">
  <option value="-1">Todas</option>
</select>

<button onclick="gerarEscala()">Gerar Escala</button>
<button onclick="window.print()">Imprimir Escala</button>

<div id="relatorio"></div>

<script>
  // Configuração Firebase (substitua pelos seus dados)
// Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCMYqcUU-fOB5nQoU2lBVnJIU_xzsk3eC0",
  authDomain: "escala-18337.firebaseapp.com",
  databaseURL: "https://escala-18337-default-rtdb.firebaseio.com",
  projectId: "escala-18337",
  storageBucket: "escala-18337.appspot.com",
  messagingSenderId: "623332895586",
  appId: "1:623332895586:web:7070007bc7accfea1fda3b",
  measurementId: "G-RLP96MKFRR"
};

// Inicialização do Firebase
let database;
try {
  const app = firebase.initializeApp(firebaseConfig);
  database = firebase.database();
  console.log("Firebase inicializado com sucesso");
} catch (error) {
  console.error("Erro ao inicializar Firebase:", error);
  alert("Erro ao conectar com o banco de dados. Verifique sua conexão com a internet.");
}

  const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
                 "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

  // Exemplo de equipes fixas — ajuste conforme seu cadastro no Firebase se quiser
  const equipes = ["Equipe A", "Equipe B", "Equipe C"];

  // Para armazenar afastamentos e observações se precisar (vazio por enquanto)
  let afastamentos = [];
  let observacoes = [];

  function preencherMesAno() {
    const selectMes = document.getElementById('selectMes');
    const selectAno = document.getElementById('selectAno');
    const selectEquipe = document.getElementById('selectEquipe');

    // Preencher meses
    for(let i=0; i<meses.length; i++) {
      let opt = document.createElement('option');
      opt.value = i;
      opt.text = meses[i];
      selectMes.appendChild(opt);
    }
    selectMes.value = new Date().getMonth();

    // Preencher anos (exemplo: 2023 a 2030)
    for(let y=2023; y<=2030; y++) {
      let opt = document.createElement('option');
      opt.value = y;
      opt.text = y;
      selectAno.appendChild(opt);
    }
    selectAno.value = new Date().getFullYear();

    // Preencher equipes
    equipes.forEach((eq, idx) => {
      let opt = document.createElement('option');
      opt.value = idx;
      opt.text = eq;
      selectEquipe.appendChild(opt);
    });
    selectEquipe.value = -1;
  }

  // Função para carregar dados da escala do Firebase
  async function carregarDados() {
    return new Promise((resolve, reject) => {
      db.ref('escala').once('value', snapshot => {
        const data = snapshot.val() || {};
        resolve(data);
      }, error => reject(error));
    });
  }

  // Função que gera o calendário da escala filtrando por mês, ano e equipe
  async function gerarEscala() {
    const mes = parseInt(document.getElementById('selectMes').value);
    const ano = parseInt(document.getElementById('selectAno').value);
    const eqIdx = parseInt(document.getElementById('selectEquipe').value);

    // Carrega todos os dados
    const escalaDados = await carregarDados();

    // Filtrar os dados para o mês, ano e equipe selecionados
    // Supondo que no Firebase você tem estrutura:
    // escala: {
    //   "2025-08-01": [{nome:"Fulano", equipe:"Equipe A", turno:"Manhã"}, ...],
    //   "2025-08-02": [...],
    //   ...
    // }

    // Vamos montar uma tabela do mês com os dias
    // Primeiro, pega quantos dias no mês
    const totalDias = new Date(ano, mes + 1, 0).getDate();

    let html = `<h3>Escala - ${meses[mes]} / ${ano}</h3>`;
    html += `<table><thead><tr><th>Dia</th><th>Escala</th></tr></thead><tbody>`;

    for(let dia = 1; dia <= totalDias; dia++) {
      // Formatar data YYYY-MM-DD
      const diaStr = dia.toString().padStart(2, '0');
      const mesStr = (mes+1).toString().padStart(2, '0');
      const dataKey = `${ano}-${mesStr}-${diaStr}`;

      const registros = escalaDados[dataKey] || [];

      // Se selecionou uma equipe específica, filtra
      const registrosFiltrados = (eqIdx === -1) ? registros : registros.filter(r => r.equipe === equipes[eqIdx]);

      // Monta texto da escala do dia
      let escalaDia = registrosFiltrados.length > 0 ?
        registrosFiltrados.map(r => `${r.nome} (${r.turno})`).join(", ") :
        "<i>Sem escala</i>";

      html += `<tr><td>${diaStr}/${mesStr}</td><td>${escalaDia}</td></tr>`;
    }

    html += `</tbody></table>`;

    document.getElementById('relatorio').innerHTML = html;
  }

  // Ao carregar a página
  window.onload = async () => {
    preencherMesAno();
    await gerarEscala();
  };
</script>

</body>
</html>

