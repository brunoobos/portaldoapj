<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consulta da Escala</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1 { text-align: center; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
    .calendar-day { border: 1px solid #ccc; border-radius: 4px; padding: 5px; min-height: 90px; font-size: 12px; background: #fff; position: relative; }
    .calendar-day.feriado { background-color: #b0b0b0; color: #fff; }
    .calendar-day.hoje { background-color: yellow; color: black; }
    .calendar-day .data-num { font-weight: bold; }
    .work, .obs, .afastamento { margin: 2px 0; padding: 2px 4px; border-radius: 3px; font-size: 11px; }
    .work { background: #66b0ff; color: white; }
    .obs { background: orange; color: white; }
    .afastamento { background: red; color: white; }
  </style>
</head>
<body>

<h1>Consulta da Escala</h1>

<div>
  <label>Equipe:</label>
  <select id="selectEquipe"><option value="-1">Todas</option></select>
  <label>Mês:</label>
  <select id="selectMes"></select>
  <label>Ano:</label>
  <select id="selectAno"></select>
  <button onclick="gerarEscala()">Gerar Escala</button>
  <button onclick="toggleAfastamentos()">Ocultar/Mostrar Afastamentos</button>
</div>

<div id="relatorio"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCMYqcUU-fOB5nQoU2lBVnJIU_xzsk3eC0",
    authDomain: "escala-18337.firebaseapp.com",
    databaseURL: "https://escala-18337-default-rtdb.firebaseio.com",
    projectId: "escala-18337",
    storageBucket: "escala-18337.appspot.com",
    messagingSenderId: "623332895586",
    appId: "1:623332895586:web:7070007bc7accfea1fda3b",
    measurementId: "G-RLP96MKFRR"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let equipes = [], afastamentos = [], feriados = [], observacoes = {}, tarefas = [];
  let mostrarAfastamentos = true;

  const meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

  async function carregarDados() {
    const snapshot = await database.ref('escala24x96').once('value');
    const data = snapshot.val() || {};
    equipes = data.equipes || [];
    afastamentos = data.afastamentos || [];
    feriados = data.feriados || [];
    observacoes = data.observacoes || {};
    tarefas = data.tarefas || [];

    const sel = document.getElementById('selectEquipe');
    sel.innerHTML = '<option value="-1">Todas</option>';
    equipes.forEach((eq, i) => sel.innerHTML += `<option value="${i}">${eq.nome || 'Equipe ' + (i + 1)}</option>`);
  }

  function preencherMesAno() {
    const selectMes = document.getElementById('selectMes');
    const selectAno = document.getElementById('selectAno');
    selectMes.innerHTML = '';
    meses.forEach((m, i) => selectMes.innerHTML += `<option value="${i}">${m}</option>`);
    let anoAtual = new Date().getFullYear();
    selectAno.innerHTML = '';
    for(let a = anoAtual - 1; a <= anoAtual + 2; a++) {
      selectAno.innerHTML += `<option value="${a}">${a}</option>`;
    }
    selectMes.value = new Date().getMonth();
    selectAno.value = anoAtual;
  }

  function toggleAfastamentos() {
    mostrarAfastamentos = !mostrarAfastamentos;
    gerarEscala();
  }

  function gerarEscala() {
    const mes = parseInt(document.getElementById('selectMes').value);
    const ano = parseInt(document.getElementById('selectAno').value);
    const eqIdx = parseInt(document.getElementById('selectEquipe').value);
    const eqs = eqIdx === -1 ? equipes : [equipes[eqIdx]];

    let html = `<h3>Escala ${meses[mes]}/${ano}</h3>`;
    const diasMes = new Date(ano, mes + 1, 0).getDate();
    const primeiroDia = new Date(ano, mes, 1).getDay();

    html += `<div class="calendar">`;
    for(let i=0; i<primeiroDia; i++) html += `<div></div>`;
    for(let dia=1; dia<=diasMes; dia++) {
      const dataStr = `${ano}-${(mes+1).toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
      const hoje = new Date();
      const isHoje = dia === hoje.getDate() && mes === hoje.getMonth() && ano === hoje.getFullYear();
      const isFeriado = feriados.includes(dataStr);
      html += `<div class="calendar-day ${isHoje ? 'hoje' : ''} ${isFeriado ? 'feriado' : ''}">
        <div class="data-num">${dia}</div>`;

      // Trabalhos
      eqs.forEach(eq => {
        if (!eq.datas) return;
        const trabalho = eq.datas.find(d => d.data === dataStr);
        if (trabalho) html += `<div class="work">${eq.nome}</div>`;
      });

      // Afastamentos
      if (mostrarAfastamentos) {
        afastamentos.forEach(a => {
          if (!a.inicio || !a.fim || !a.nome) return;
          const data = new Date(dataStr);
          const dtInicio = new Date(a.inicio);
          const dtFim = new Date(a.fim);
          if (data >= dtInicio && data <= dtFim) {
            html += `<div class="afastamento">${a.nome}</div>`;
          }
        });
      }

      // Observações
      if (observacoes[dataStr]) {
        html += `<div class="obs">${observacoes[dataStr]}</div>`;
      }

      html += `</div>`;
    }
    html += `</div>`;
    document.getElementById('relatorio').innerHTML = html;
  }

  window.onload = () => {
    preencherMesAno();
    carregarDados();
  };
</script>

</body>
</html>
