<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escala 24x7 - Visualização</title>

<style>
  body {
    font-family: Arial, sans-serif;
  }
  label, select, button {
    margin: 0 8px 12px 0;
  }
  #relatorio {
    margin-top: 20px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #666;
    padding: 6px;
    text-align: center;
    font-size: 14px;
  }
  th {
    background-color: #eee;
  }

  /* Responsividade para celular */
  @media screen and (max-width: 600px) {
    select, button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }
    td, th {
      font-size: 12px;
    }
  }

  /* Estilo para impressão */
  @media print {
    body * {
      visibility: hidden;
    }
    #relatorio, #relatorio * {
      visibility: visible;
    }
    #relatorio {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
  }
</style>

<!-- Firebase SDK Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<h2>Visualização da Escala</h2>

<label for="selectMes">Mês:</label>
<select id="selectMes"></select>

<label for="selectAno">Ano:</label>
<select id="selectAno"></select>

<label for="selectEquipe">Equipe:</label>
<select id="selectEquipe">
  <option value="-1">Todas</option>
</select>

<button onclick="gerarEscala()">Gerar Escala</button>
<button onclick="imprimirPDF()">Imprimir Escala</button>

<div id="relatorio"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCMYqcUU-fOB5nQoU2lBVnJIU_xzsk3eC0",
  authDomain: "escala-18337.firebaseapp.com",
  databaseURL: "https://escala-18337-default-rtdb.firebaseio.com",
  projectId: "escala-18337",
  storageBucket: "escala-18337.appspot.com",
  messagingSenderId: "623332895586",
  appId: "1:623332895586:web:7070007bc7accfea1fda3b",
  measurementId: "G-RLP96MKFRR"
};

let db;
try {
  const app = firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch (error) {
  console.error("Erro Firebase", error);
  alert("Erro ao conectar ao banco de dados.");
}

const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
               "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

const equipes = ["Equipe A", "Equipe B", "Equipe C"];

function preencherMesAno() {
  const selectMes = document.getElementById('selectMes');
  const selectAno = document.getElementById('selectAno');
  const selectEquipe = document.getElementById('selectEquipe');

  for(let i=0; i<meses.length; i++) {
    let opt = document.createElement('option');
    opt.value = i;
    opt.text = meses[i];
    selectMes.appendChild(opt);
  }
  selectMes.value = new Date().getMonth();

  for(let y=2023; y<=2030; y++) {
    let opt = document.createElement('option');
    opt.value = y;
    opt.text = y;
    selectAno.appendChild(opt);
  }
  selectAno.value = new Date().getFullYear();

  equipes.forEach((eq, idx) => {
    let opt = document.createElement('option');
    opt.value = idx;
    opt.text = eq;
    selectEquipe.appendChild(opt);
  });
  selectEquipe.value = -1;
}

async function carregarDados() {
  return new Promise((resolve, reject) => {
    db.ref('escala').once('value', snapshot => {
      resolve(snapshot.val() || {});
    }, error => reject(error));
  });
}

async function gerarEscala() {
  const mes = parseInt(document.getElementById('selectMes').value);
  const ano = parseInt(document.getElementById('selectAno').value);
  const eqIdx = parseInt(document.getElementById('selectEquipe').value);

  const escalaDados = await carregarDados();
  const totalDias = new Date(ano, mes + 1, 0).getDate();
  let html = `<h3>Escala - ${meses[mes]} / ${ano}</h3>`;
  html += `<table><thead><tr><th>Dia</th><th>Escala</th></tr></thead><tbody>`;

  for(let dia = 1; dia <= totalDias; dia++) {
    const diaStr = dia.toString().padStart(2, '0');
    const mesStr = (mes+1).toString().padStart(2, '0');
    const dataKey = `${ano}-${mesStr}-${diaStr}`;

    const registros = escalaDados[dataKey] || [];
    const registrosFiltrados = (eqIdx === -1) ? registros : registros.filter(r => r.equipe === equipes[eqIdx]);

    let escalaDia = registrosFiltrados.length > 0 ?
      registrosFiltrados.map(r => `${r.nome} (${r.turno})`).join(", ") :
      "<i>Sem escala</i>";

    html += `<tr><td>${diaStr}/${mesStr}</td><td>${escalaDia}</td></tr>`;
  }

  html += `</tbody></table>`;
  document.getElementById('relatorio').innerHTML = html;
}

function imprimirPDF() {
  gerarEscala().then(() => {
    setTimeout(() => window.print(), 500);
  });
}

window.onload = async () => {
  preencherMesAno();
  await gerarEscala();
};
</script>

</body>
</html>


