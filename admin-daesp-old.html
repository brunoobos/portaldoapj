<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Escala 24x96 - Admin Completo</title>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<style>
  /* Seus estilos permanecem os mesmos */
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
  h1 { text-align: center; }
  .section { background: #fff; border-radius: 5px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 5px #ccc; }
  button { padding: 8px 15px; margin: 5px; cursor: pointer; border-radius: 4px; border: none; }
  button#btnAddEquipe { background: #28a745; color: white; }
  button#btnSalvar { background: #007bff; color: white; }
  button#btnVisualizar { background: #ffc107; }
  button#btnExcluir { background: #dc3545; color: white; }
  button#btnGerarEscala { background: #17a2b8; color: white; }
  button#btnAfastamentos { background: #6f42c1; color: white; }
  button#btnFeriados { background: #6c757d; color: white; }
  button#btnAddTarefa { background: #28a745; color: white; margin-bottom: 10px; }
  button#btnExcluirAfastamento { background:#dc3545; color:white; margin-left:5px; }
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
  .calendar-day { border: 1px solid #ccc; border-radius: 4px; padding: 5px; min-height: 90px; font-size: 12px; background: #fff; position: relative; }
  .calendar-day.feriado { background-color: #b0b0b0 !important; color: #fff; }
  .calendar-day.hoje { background-color: yellow !important; color: black; }
  .calendar-day .data-num { font-weight: bold; }
  .work { margin: 2px 0; padding: 2px 4px; border-radius: 3px; cursor: pointer; }
  .work.extra-name { background: #ff66b2; color: white; } /* cor rosa para nomes extras */
  .afastamento { margin: 2px 0; padding: 2px 4px; border-radius: 3px; font-size: 11px; color: #fff; }
  .ferias { background: #ffc107; color: #333; }
  .licenca { background: #dc3545; }
  .compensacao { background: #6f42c1; }

  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
           background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; position: relative; }
  .modal-content label { display: block; margin: 10px 0 4px; }
  .modal-content input, .modal-content select { width: 100%; padding: 6px; box-sizing: border-box; }
  .close { position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; }
  

</style>
</head>
<body>

<!-- Seu HTML permanece o mesmo -->
<h1>Administração da Escala 24x96</h1>

<div class="section" id="equipes-container"></div>

<button id="btnAddEquipe">Adicionar Equipe</button>
<button id="btnSalvar">Salvar Equipes</button>
<button id="btnVisualizar">Visualizar Equipes</button>
<button id="btnExcluir">Excluir Equipe</button>
<button id="btnAfastamentos">Cadastrar Afastamentos</button>
<button id="btnExcluirAfastamento">Excluir Afastamento</button>
<button id="btnFeriados">Cadastrar Feriados</button>
<button id="btnExcluirFeriado">Excluir Feriado</button>

<div class="section">
  <h2>Gerar Relatório da Escala</h2>
  <label for="selectEquipe">Equipe:</label>
  <select id="selectEquipe"><option value="-1">Todas as equipes</option></select><br/>
  <label for="selectMes">Mês:</label>
  <select id="selectMes"></select><br/>
  <label for="selectAno">Ano:</label>
  <select id="selectAno"></select><br/>
  <button id="btnGerarEscala">Gerar Escala Mensal</button>
</div>

<button id="btnAddTarefa">Adicionar Tarefa</button>

<div id="relatorio"></div>

<!-- Modal afastamento -->
<div id="modalAfastamento" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModal('modalAfastamento')">&times;</span>
    <h3>Cadastrar Afastamento</h3>
    <label>Equipe:</label>
    <select id="modalEquipe"></select>
    <label>Membro:</label>
    <select id="modalMembro">
      <option value="F">Fixo</option>
      <option value="R0">Rotativo 1</option>
      <option value="R1">Rotativo 2</option>
      <option value="R2">Rotativo 3</option>
    </select>
    <label>Tipo:</label>
    <select id="modalTipo">
      <option value="FERIAS">Férias</option>
      <option value="LICENCA">Licença</option>
      <option value="COMPENSACAO">Compensação</option>
    </select>
    <label>Data início:</label>
    <input type="date" id="modalInicio" />
    <label>Data fim:</label>
    <input type="date" id="modalFim" />
    <br /><br />
    <button onclick="salvarAfastamento()">Salvar</button>
  </div>
</div>

    <!-- Modal feriado -->
    <div id="modalFeriado" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModal('modalFeriado')">&times;</span>
        <h3>Cadastrar Feriado</h3>
        <label>Data do Feriado:</label>
        <input type="date" id="feriadoData" />
        <br /><br />
        <button onclick="salvarFeriado()">Salvar Feriado</button>
      </div>
    </div>

<!-- Modal tarefa -->
<div id="modalTarefa" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModal('modalTarefa')">&times;</span>
    <h3>Adicionar Tarefa</h3>
    <label>Nome da Pessoa:</label>
    <input type="text" id="inputNomeTarefa" />
    <label>Data:</label>
    <input type="date" id="inputDataTarefa" />
    <label>Descrição:</label>
    <input type="text" id="inputDescricaoTarefa" />
    <br /><br />
    <button onclick="salvarNovaTarefa()">Salvar</button>
  </div>
</div>


<script>
  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCMYqcUU-fOB5nQoU2lBVnJIU_xzsk3eC0",
    authDomain: "escala-18337.firebaseapp.com",
    databaseURL: "https://escala-18337-default-rtdb.firebaseio.com",
    projectId: "escala-18337",
    storageBucket: "escala-18337.appspot.com",
    messagingSenderId: "623332895586",
    appId: "1:623332895586:web:7070007bc7accfea1fda3b",
    measurementId: "G-RLP96MKFRR"
  };

  // Inicialização do Firebase
  let database;
  try {
    const app = firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    console.log("Firebase inicializado com sucesso");
  } catch (error) {
    console.error("Erro ao inicializar Firebase:", error);
    alert("Erro ao conectar com o banco de dados. Verifique sua conexão com a internet.");
  }

  // Variáveis globais
  let equipes = [];
  let afastamentos = [];
  let feriados = [];
  let observacoes = {};
  let tarefas = [];
  const meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

  // Funções do Firebase
  async function salvarEquipes() {
    try {
      await database.ref('equipes').set(equipes);
      alert("Equipes salvas com sucesso!");
    } catch (error) {
      console.error("Erro ao salvar equipes:", error);
      alert("Erro ao salvar equipes. Verifique sua conexão.");
    }
  }

  async function salvarAfastamentos() {
    try {
      await database.ref('afastamentos').set(afastamentos);
    } catch (error) {
      console.error("Erro ao salvar afastamentos:", error);
    }
  }

  async function salvarFeriados() {
    try {
      await database.ref('feriados').set(feriados);
    } catch (error) {
      console.error("Erro ao salvar feriados:", error);
    }
  }

  async function salvarObservacoes() {
    try {
      await database.ref('observacoes').set(observacoes);
    } catch (error) {
      console.error("Erro ao salvar observações:", error);
    }
  }

  async function salvarTarefas() {
    try {
      await database.ref('tarefas').set(tarefas);
    } catch (error) {
      console.error("Erro ao salvar tarefas:", error);
    }
  }

  async function carregarDados() {
    showLoading(true);
    try {
      const [equipesSnapshot, afastamentosSnapshot, feriadosSnapshot, observacoesSnapshot, tarefasSnapshot] = await Promise.all([
        database.ref('equipes').once('value'),
        database.ref('afastamentos').once('value'),
        database.ref('feriados').once('value'),
        database.ref('observacoes').once('value'),
        database.ref('tarefas').once('value')
      ]);
      
      equipes = equipesSnapshot.val() || [];
      afastamentos = afastamentosSnapshot.val() || [];
      feriados = feriadosSnapshot.val() || [];
      observacoes = observacoesSnapshot.val() || {};
      tarefas = tarefasSnapshot.val() || [];
      
      renderEquipes();
      preencherMesAno();
      gerarEscala();
    } catch (error) {
      console.error("Erro ao carregar dados:", error);
      alert("Erro ao carregar dados. Verifique sua conexão.");
    } finally {
      showLoading(false);
    }
  }

  // Funções da aplicação (ajustadas para Firebase)
  async function salvarAfastamento() {
    let eq = parseInt(document.getElementById('modalEquipe').value);
    let membro = document.getElementById('modalMembro').value;
    let tipo = document.getElementById('modalTipo').value;
    let inicio = document.getElementById('modalInicio').value;
    let fim = document.getElementById('modalFim').value;
    if (!inicio || !fim) return alert('Preencha datas.');
    
    afastamentos.push({ equipe: eq, membro, tipo, inicio, fim });
    await salvarAfastamentos();
    fecharModal('modalAfastamento');
    gerarEscala();
  }

  async function salvarFeriado() {
    let data = document.getElementById('feriadoData').value;
    if (!data) return alert('Selecione a data do feriado.');
    if (!feriados.includes(data)) {
      feriados.push(data);
      await salvarFeriados();
    } else {
      alert('Feriado já cadastrado.');
    }
    fecharModal('modalFeriado');
    gerarEscala();
  }

  async function excluirAfastamento() {
    if (afastamentos.length === 0) {
      alert('Nenhum afastamento cadastrado.');
      return;
    }

    let lista = 'Afastamentos cadastrados:\n';
    afastamentos.forEach((af, i) => {
      let equipeNome = equipes[af.equipe]?.nome || 'Equipe desconhecida';
      let membroNome =
        af.membro === 'F'
          ? equipes[af.equipe]?.fixo || 'Fixo desconhecido'
          : equipes[af.equipe]?.rotativos[parseInt(af.membro[1])] || 'Rotativo desconhecido';

      lista += `${i}: ${equipeNome} - ${membroNome} (${af.tipo}) de ${af.inicio} até ${af.fim}\n`;
    });

    let idx = prompt(lista + '\nDigite o número do afastamento que deseja excluir:');
    idx = parseInt(idx);
    if (!isNaN(idx) && idx >= 0 && idx < afastamentos.length) {
      if (confirm(`Confirma excluir o afastamento:\n${lista.split('\n')[idx + 1]}`)) {
        afastamentos.splice(idx, 1);
        await salvarAfastamentos();
        alert('Afastamento excluído!');
        gerarEscala();
      }
    } else {
      alert('Índice inválido.');
    }
  }

  async function excluirFeriado() {
    if (feriados.length === 0) return alert('Nenhum feriado cadastrado.');
    let lista = 'Feriados cadastrados:\n';
    feriados.forEach((f, i) => lista += `${i}: ${f}\n`);
    let idx = prompt(lista + '\nDigite o número do feriado a excluir:');
    idx = parseInt(idx);
    if (!isNaN(idx) && idx >= 0 && idx < feriados.length) {
      if (confirm(`Confirma excluir o feriado ${feriados[idx]}?`)) {
        feriados.splice(idx, 1);
        await salvarFeriados();
        alert('Feriado excluído!');
        gerarEscala();
      }
    } else {
      alert('Índice inválido.');
    }
  }

  async function salvarNovaTarefa() {
    let nome = document.getElementById('inputNomeTarefa').value.trim();
    let data = document.getElementById('inputDataTarefa').value;
    let descricao = document.getElementById('inputDescricaoTarefa').value.trim();
    if (!nome || !data || !descricao) return alert('Preencha todos os campos da tarefa.');
    tarefas.push({ nome, data, descricao });
    await salvarTarefas();
    fecharModal('modalTarefa');
    gerarEscala();
  }

  async function editarTarefa(index) {
    let t = tarefas[index];
    if (!t) return;
    let novoNome = prompt("Editar nome da pessoa:", t.nome);
    if (novoNome === null) return;
    if (novoNome === '') {
      if (confirm("Deseja excluir esta tarefa?")) {
        tarefas.splice(index, 1);
        await salvarTarefas();
        gerarEscala();
      }
      return;
    }
    let novaDesc = prompt("Editar descrição da tarefa:", t.descricao);
    if (novaDesc === null) return;
    t.nome = novoNome.trim();
    t.descricao = novaDesc.trim();
    await salvarTarefas();
    gerarEscala();
  }

  // ... (demais funções permanecem iguais, apenas garantindo que chamam as funções async do Firebase)
  

  // Inicialização
  window.addEventListener('DOMContentLoaded', async () => {
    if (!database) {
      alert("Não foi possível conectar ao Firebase. Verifique sua conexão com a internet.");
      return;
    }
    await carregarDados();
  });

  // Event listeners
  document.getElementById('btnAddEquipe').onclick = () => {
    equipes.push({ nome: '', dataInicio: '', fixo: '', rotativos: ['', '', ''] });
    renderEquipes();
  };
  document.getElementById('btnSalvar').onclick = salvarEquipes;
  document.getElementById('btnExcluirAfastamento').onclick = excluirAfastamento;
  document.getElementById('btnExcluirFeriado').onclick = excluirFeriado;
  // ... outros event listeners
</script>
</body>
</html>
